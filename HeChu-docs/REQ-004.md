# REQ-004: 需求数据模型修复（已满足/总需求显示）

## 状态
- [ ] 待开发
- [ ] 开发中
- [x] 已完成

## 创建信息
- 创建时间: 2026-02-11
- 最后更新: 2026-02-11
- 优先级: 高

## 需求描述
原型（Python）中，行列需求以"已满足/总需求"格式展示（例如 "1/2" 表示总共需要 2 个，已有 1 个预置锁定格满足）。但 C# 应用程序的 `ColorRequirement.Count` 仅记录了**未满足**的需求数量（过滤掉了 `filled: true` 的项），而算法 (`Solver.fs`) 中的 `countRowColors` / `countColColors` 统计的是该行/列中**所有** Lock 类型格子的数量（包含预置锁定格）。

这导致约束检查不等式 `actual <= required` 中 `actual` 包含预置格而 `required` 不包含，使得有预置锁定格的行/列立即被判定为"违反约束"，进而导致本应有解的谜题（如 puzzle0）被误判为无解。

## 修复方案
1. `ColorRequirement` 增加 `FilledCount` 字段，记录已由预置锁定格满足的数量
2. `ColorRequirement.Count` 改为存储**总需求数**（filled + unfilled），而非仅 unfilled
3. `LoadFromJson` 和 `FindBars` 中的需求解析逻辑同步修改
4. UI 侧绘制需求时以"已满足/总数"格式显示，与原型一致

## 边界条件
- 某行/列的需求可能全部为 filled（预置格已全部满足），此时 Count = FilledCount，算法无需额外放置
- 某行/列可能没有任何需求（空数组），不受影响
- 算法的剪枝逻辑 `checkAffectedConstraints` 和终验 `checkAllRequirements` 无需修改，因为它们都比较 actual vs Count（total）

## 技术路线
- 修改 `ColorRequirement` record 添加 `FilledCount` 参数
- 修改 `PuzzleDetector.LoadFromJson` 和 `FindBars` 中的需求聚合逻辑
- 修改 `MainWindow.xaml.cs` 中 `DrawBoard` 的需求显示格式

## 参考
- Python 原型 `detect.py` 中 `filled` 字段的处理逻辑
- `prototype/image/output/puzzle0_result.json` 中的需求数据结构

## 相关文件
- `src/EndfieldPuzzleSolver.Recognition/Models/PuzzleModels.cs` - `ColorRequirement` record 添加 `FilledCount` 参数
- `src/EndfieldPuzzleSolver.Recognition/PuzzleDetector.cs` - `LoadFromJson` 和 `FindBars` 的需求聚合逻辑改为统计总数
- `src/EndfieldPuzzleSolver/MainWindow.xaml.cs` - 需求显示改为 "已满足/总数" 格式，添加 `CountColorInRow`/`CountColorInCol` 辅助方法
