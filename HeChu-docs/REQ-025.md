# REQ-025: Docker å®¹å™¨åŒ–éƒ¨ç½²

**æ—¥æœŸ**: 2026-02-16  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**å…³è”éœ€æ±‚**: åç«¯APIéƒ¨ç½²

## ğŸ“‹ éœ€æ±‚æ¦‚è¿°

å°†åç«¯ API é¡¹ç›®æ‰“åŒ…ä¸º Docker é•œåƒå¹¶å‘å¸ƒåˆ° Docker Hubï¼Œä»¥ä¾¿äºéƒ¨ç½²å’Œåˆ†å‘ã€‚

## ğŸ¯ ç›®æ ‡

- åˆ›å»º Dockerfile é…ç½®
- æ„å»º Docker é•œåƒ
- æµ‹è¯•é•œåƒè¿è¡Œ
- å‘å¸ƒåˆ° Docker Hub
- æ›´æ–°æ–‡æ¡£è¯´æ˜

## ğŸ”§ æŠ€æœ¯å®ç°

### Dockerfile é…ç½®

ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–é•œåƒå¤§å°ï¼š

```dockerfile
# åŸºç¡€é•œåƒï¼ˆè¿è¡Œæ—¶ï¼‰
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS base
WORKDIR /app
EXPOSE 8080

# å®‰è£… OpenCV è¿è¡Œæ—¶ä¾èµ–
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgdiplus \
    libc6-dev \
    libx11-6 \
    && rm -rf /var/lib/apt/lists/*

# æ„å»ºé•œåƒ
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /src

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶å¹¶è¿˜åŸä¾èµ–
COPY src/EndfieldPuzzleSolver.Api/EndfieldPuzzleSolver.Api.csproj src/EndfieldPuzzleSolver.Api/
COPY src/EndfieldPuzzleSolver.Recognition/EndfieldPuzzleSolver.Recognition.csproj src/EndfieldPuzzleSolver.Recognition/
COPY src/EndfieldPuzzleSolver.Algorithm/EndfieldPuzzleSolver.Algorithm.fsproj src/EndfieldPuzzleSolver.Algorithm/

RUN dotnet restore src/EndfieldPuzzleSolver.Api/EndfieldPuzzleSolver.Api.csproj

# å¤åˆ¶æºç å¹¶å‘å¸ƒ
COPY src/ src/
WORKDIR /src/src/EndfieldPuzzleSolver.Api
RUN dotnet publish -c Release -o /app/publish --no-restore

# æœ€ç»ˆé•œåƒ
FROM base AS final
WORKDIR /app
COPY --from=build /app/publish .
ENV ASPNETCORE_URLS=http://+:8080
ENTRYPOINT ["dotnet", "EndfieldPuzzleSolver.Api.dll"]
```

### å…³é”®ä¾èµ–é…ç½®

**æ³¨æ„**: `EndfieldPuzzleSolver.Recognition.csproj` åªéœ€è¦ Windows è¿è¡Œæ—¶åŒ…ï¼š

```xml
<ItemGroup>
  <PackageReference Include="OpenCvSharp4" Version="4.11.0.20250507" />
  <PackageReference Include="OpenCvSharp4.runtime.win" Version="4.11.0.20250507" />
</ItemGroup>
```

- âŒ ä¸è¦æ·»åŠ  `OpenCvSharp4.runtime.linux` - NuGet ä¸Šä¸å­˜åœ¨æ­¤åŒ…
- âœ… é€šè¿‡ Dockerfile çš„ `apt-get` å®‰è£…ç³»ç»Ÿçº§ OpenCV ä¾èµ–
- âœ… OpenCvSharp4 ä¼šè‡ªåŠ¨é€‚é… Linux ç¯å¢ƒçš„ OpenCV åº“

## ğŸ“¦ ä½¿ç”¨æ–¹å¼

### ä» Docker Hub æ‹‰å–

```bash
# æ‹‰å–æœ€æ–°é•œåƒ
docker pull hechuqiu/endfield-puzzle-solver-api:latest

# è¿è¡Œå®¹å™¨
docker run -d -p 8080:8080 --name endfield-api hechuqiu/endfield-puzzle-solver-api:latest

# æŸ¥çœ‹æ—¥å¿—
docker logs endfield-api

# æµ‹è¯• API
curl http://localhost:8080/api/health
```

### æœ¬åœ°æ„å»º

```bash
# æ„å»ºé•œåƒ
docker build -t endfield-puzzle-solver-api:latest -f Dockerfile .

# è¿è¡Œå®¹å™¨
docker run -d -p 8080:8080 endfield-puzzle-solver-api:latest
```

## ğŸ”Œ API ç«¯ç‚¹

é•œåƒè¿è¡Œåæä¾›ä»¥ä¸‹ç«¯ç‚¹ï¼š

- `GET /api/health` - å¥åº·æ£€æŸ¥
- `POST /api/detect-and-solve` - è¯†åˆ«å¹¶æ±‚è§£æ‹¼å›¾ï¼ˆéœ€è¦ä¸Šä¼ å›¾ç‰‡ï¼‰
- `POST /api/detect` - ä»…è¯†åˆ«æ‹¼å›¾ï¼ˆéœ€è¦ä¸Šä¼ å›¾ç‰‡ï¼‰
- `POST /api/solve` - ä»…æ±‚è§£æ‹¼å›¾ï¼ˆéœ€è¦æä¾›æ‹¼å›¾æ•°æ®ï¼‰

### æµ‹è¯•ç¤ºä¾‹

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8080/api/health

# è¯†åˆ«å¹¶æ±‚è§£ï¼ˆéœ€è¦å‡†å¤‡å›¾ç‰‡æ–‡ä»¶ï¼‰
curl -X POST http://localhost:8080/api/detect-and-solve \
  -F "image=@puzzle.png"
```

## ğŸ“¤ å‘å¸ƒæµç¨‹

### 1. æ„å»ºé•œåƒ

```bash
docker build -t endfield-puzzle-solver-api:latest -f Dockerfile .
```

### 2. æ‰“æ ‡ç­¾

```bash
docker tag endfield-puzzle-solver-api:latest hechuqiu/endfield-puzzle-solver-api:latest
```

### 3. æ¨é€åˆ° Docker Hub

```bash
docker push hechuqiu/endfield-puzzle-solver-api:latest
```

## âš ï¸ å¸¸è§é—®é¢˜

### é—®é¢˜ï¼šæ„å»ºæ—¶ NuGet æ‰¾ä¸åˆ° `OpenCvSharp4.runtime.linux`

**åŸå› **: NuGet ä»“åº“ä¸­ä¸å­˜åœ¨è¯¥åŒ…åï¼ˆæ­£ç¡®çš„åŒ…åæ˜¯ `OpenCvSharp4.runtime.ubuntu`ï¼‰ã€‚

**è§£å†³æ–¹æ¡ˆ**: 
1. ä» `EndfieldPuzzleSolver.Recognition.csproj` ä¸­ç§»é™¤è¯¥å¼•ç”¨
2. é€šè¿‡ Dockerfile å®‰è£…ç³»ç»Ÿçº§ OpenCV ä¾èµ–

### é—®é¢˜ï¼šå®¹å™¨è¿è¡Œæ—¶æ‰¾ä¸åˆ° OpenCV åº“

**è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿ Dockerfile ä¸­å®‰è£…äº†å¿…è¦çš„ä¾èµ–ï¼š
```dockerfile
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgdiplus \
    libc6-dev \
    libx11-6 \
    && rm -rf /var/lib/apt/lists/*
```

## âœ… éªŒè¯ç»“æœ

- âœ… é•œåƒæ„å»ºæˆåŠŸï¼ˆçº¦ 2 åˆ†é’Ÿï¼‰
- âœ… å®¹å™¨æ­£å¸¸å¯åŠ¨
- âœ… API å¥åº·æ£€æŸ¥æ­£å¸¸å“åº”
- âœ… é•œåƒå·²å‘å¸ƒåˆ° Docker Hub
- âœ… æ–‡æ¡£å·²æ›´æ–°

## ğŸ”— ç›¸å…³é“¾æ¥

- Docker Hub: https://hub.docker.com/r/hechuqiu/endfield-puzzle-solver-api
- é•œåƒæ ‡ç­¾: `hechuqiu/endfield-puzzle-solver-api:latest`
- API é¡¹ç›®: `src/EndfieldPuzzleSolver.Api/`

## ğŸ“ åç»­æ”¹è¿›

- [ ] æ·»åŠ é•œåƒç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰
- [ ] ä¼˜åŒ–é•œåƒå¤§å°ï¼ˆè€ƒè™‘ä½¿ç”¨ Alpine åŸºç¡€é•œåƒï¼‰
- [ ] æ·»åŠ  Docker Compose é…ç½®
- [ ] é›†æˆåˆ° CI/CD æµç¨‹
