# REQ-015: 优化C#应用程序图像识别性能 - 使用OpenCvSharp和Linq替代手动循环

## 状态
- [ ] 待开发
- [ ] 开发中
- [x] 已完成

## 创建信息
- 创建时间: 2026-02-12
- 最后更新: 2026-02-12
- 优先级: 高

## 需求描述
当前WinUI3应用程序中的图像识别性能比Python原型脚本慢数倍。主要原因是C#版本中存在大量手动嵌套循环（如在`SimilarityMapForColor`、`MatchTemplate`等函数中逐像素访问），而Python版本充分利用了NumPy的向量化操作和OpenCV的内置函数。

本需求旨在：
1. 重构图像识别核心代码，消除手动嵌套循环
2. 尽可能使用OpenCvSharp的内置矩阵操作和函数替代逐像素访问
3. 使用Linq替代手动列表遍历和过滤操作
4. 确保优化后的算法结果与Python原型实现保持一致
5. 提升代码可读性和可维护性

## 边界条件
1. **兼容性要求**：必须确保优化后的识别结果与原Python实现完全一致（输出相同的PuzzleData结构）
2. **API限制**：OpenCvSharp的某些API可能与Python OpenCV有差异，需要仔细对照文档并编写测试验证
3. **性能验证**：优化后需要进行性能测试，确保达到预期提升
4. **错误处理**：保持原有的错误处理逻辑，确保异常情况下能正常失败

## 技术路线

### 优先级 1：核心性能瓶颈优化
1. **SimilarityMapForColor函数**（605-631行）
   - 替代双重循环逐像素计算
   - 使用OpenCvSharp的矩阵操作：`Split`、`ConvertTo`、`AbsDiffScalar`、`Min`、`DivideScalar`、`Compare`、`BitwiseAnd`、`Multiply`
   - 参考Python版本：`h_arr = hsv[:, :, 0].astype(np.float32)`

2. **MatchTemplate函数**（254-273行）
   - 替代遍历res矩阵查找阈值点
   - 使用`Cv2.Threshold` + `Cv2.FindNonZero`一次性获取所有匹配点
   - 参考Python版本：`locs = np.where(res >= thresh)`

### 优先级 2：其他嵌套循环优化
3. **ClassifyCell函数**（357-447行）
   - 锁定格的像素统计（377-394行）
   - 使用OpenCvSharp的`CountNonZero`、`Mean`等内置函数

4. **FindBars函数**（483-603行）
   - 轮廓遍历和像素提取（538-548行）
   - 使用ROI和掩码操作替代手动循环

5. **ParseComponentBlob函数**（764-902行）
   - 颜色提取和形状分析（871-884行）
   - 使用矩阵操作和掩码

### 优先级 3：Linq重构
6. **列表操作重构**
   - `Nms`函数（275-289行）：使用`OrderByDescending`和`Where`的Linq链式调用
   - `InferGrid`函数（302-327行）：使用`Select`、`Distinct`、`OrderBy`替代手动列表操作
   - `DetectComponents`函数（633-659行）：使用`OrderBy`排序

### 验证方法
1. 单元测试：使用相同的测试图片对比优化前后的输出
2. 性能基准测试：记录优化前后的执行时间
3. 边界测试：验证极端情况（如空图片、超大图片等）

## 参考
- **Python原型脚本**：`prototype/detect.py`（已使用NumPy向量化操作）
- **NumPy vs C#循环对比**：
  - NumPy：`hue_sim = np.maximum(0.0, 1.0 - d / hue_width)`（一次操作整个数组）
  - C#当前：双重循环逐像素访问（数量级差异）

## 相关文件
- `src/EndfieldPuzzleSolver.Recognition/PuzzleDetector.cs` - 主要优化目标
- `src/EndfieldPuzzleSolver.Recognition/ColorGrouper.cs` - 辅助优化
- `prototype/detect.py` - 参考实现
