# REQ-003: WinUI 3 正式应用程序

## 状态
- [ ] 待开发
- [ ] 开发中
- [x] 已完成

## 创建信息
- 创建时间: 2026-02-11
- 最后更新: 2026-02-12
- 优先级: 高

## 需求描述

将原型验证阶段的成果（REQ-001、REQ-002）转化为正式的桌面应用程序，采用 WinUI 3 + C# 构建 UI 和图像识别，F# 编写解题算法，支持 NativeAOT 编译。

### 功能模式

1. **截图导入模式**：导入游戏截图 → 自动识别谜题数据 → 求解 → 展示结果
2. **手动输入模式**：用户手动输入/编辑谜题数据（网格、元件、行列需求）→ 求解 → 展示结果

### 结果展示

- **彩色网格可视化**：将求解结果渲染为彩色网格，各元件着色显示在棋盘上
- **逐步查看**：可选逐步回放每个元件的放置过程（前进/后退），便于理解解法

### 图像识别

- 将 Python 原型（`prototype/detect.py`）的识别逻辑移植到 C#（使用 OpenCvSharp）
- 移植后需用现有样例（`prototype/image/sample/puzzle0.png`、`puzzle1.png`）测试，确保识别结果与 Python 原型一致

### 解题算法（F# / 用户自行编写）

- 算法采用递归动态规划思路，由用户自行实现
- 开发者（我）提供：
  - F# 项目骨架和数据类型定义
  - 算法方法签名和 TODO 占位
  - **分步记录模板**：算法执行过程中记录每一步的放置操作（元件编号、位置、棋盘快照），使 UI 能够逐步回放，而非仅返回最终结果

## 边界条件

- 识别失败时给出友好错误提示（如"无法定位游戏网格，请确保截图包含完整游戏界面"）
- 无解时提示"此谜题无解"
- 支持多色谜题（如 puzzle1 的蓝色 + 黄绿色双色场景）
- 元件可能需要旋转/翻转（取决于游戏规则，算法层面预留接口）
- AOT 编译兼容性：所有依赖（OpenCvSharp、F# 互操作）需确保 NativeAOT 兼容

## 技术路线

### 解决方案结构

```
EndfieldPuzzleSolver.sln
├── src/
│   ├── EndfieldPuzzleSolver/              # WinUI 3 C# 主项目（UI + 入口）
│   ├── EndfieldPuzzleSolver.Recognition/  # C# 类库（图像识别，OpenCvSharp）
│   └── EndfieldPuzzleSolver.Algorithm/    # F# 类库（解题算法，用户编写）
```

### 技术选型

| 层面 | 技术 |
|------|------|
| UI 框架 | WinUI 3 (Windows App SDK) |
| 编程语言 | C#（UI + 识别）、F#（算法） |
| 图像识别 | OpenCvSharp4 |
| 编译方式 | NativeAOT (`PublishAot=true`) |
| 目标框架 | .NET 9+ |
| 构建工具 | dotnet CLI / MSBuild |

### 数据流

```
截图/手动输入
    ↓
[Recognition] PuzzleData（结构化谜题数据）
    ↓
[Algorithm]   SolveResult（分步解法 or 无解）
    ↓
[UI]          彩色网格 + 逐步回放
```

### 核心数据类型（C# 共享，F# 消费）

```
PuzzleData:
  - GridSize: (rows, cols)
  - Tiles[row, col]: Empty | Disabled | Lock(colorGroup)
  - Requirements:
      - Columns[col]: list of (colorGroup, count)
      - Rows[row]: list of (colorGroup, count)
  - Components[]: shape (bool[,]) + colorGroup

SolveStep:
  - ComponentIndex: int
  - Position: (row, col)
  - Rotation: int (0/90/180/270)
  - BoardSnapshot: Tile[,]

SolveResult:
  - Solved(steps: SolveStep list)
  | NoSolution
```

### 分步展示支持

算法模板设计为：
1. 每次成功放置一个元件时，记录一个 `SolveStep`（包含元件编号、放置位置、当前棋盘快照）
2. 最终返回 `SolveStep` 列表，UI 按顺序回放
3. 用户实现递归 DP 时只需在回溯过程中调用 `recordStep()` 即可

### 图像识别移植要点

| Python 原型 | C# 对应 |
|-------------|---------|
| `cv2.matchTemplate` | `Cv2.MatchTemplate` (OpenCvSharp) |
| `cv2.findContours` | `Cv2.FindContours` |
| `cv2.cvtColor` (HSV) | `Cv2.CvtColor` |
| numpy 数组操作 | `Mat` + OpenCvSharp API |
| 多尺度缩放探测 | 同样逻辑移植 |
| JSON 输出 | 直接转为 `PuzzleData` 对象 |

### AOT 注意事项

- OpenCvSharp 使用 P/Invoke 调用原生库，NativeAOT 兼容
- F# 标准库在 .NET 9 支持 NativeAOT
- 避免使用反射（`System.Reflection.Emit`）、动态代码生成
- WinUI 3 XAML 编译器需使用 `x:Bind` 而非 `{Binding}` 以减少反射依赖

## 参考

- REQ-001 Python 原型识别逻辑（`prototype/detect.py`）
- REQ-002 多分辨率缩放支持
- 现有识别结果 JSON（`prototype/image/output/puzzle0_result.json`）作为移植验证基准
- OpenCvSharp4 NuGet 包
- Windows App SDK / WinUI 3 文档

## 已完成的工作

### 解决方案结构（已创建）
- `EndfieldPuzzleSolver.sln` — 解决方案文件
- `src/EndfieldPuzzleSolver/` — WinUI 3 主项目（UI + 入口）
- `src/EndfieldPuzzleSolver.Recognition/` — C# 图像识别类库
- `src/EndfieldPuzzleSolver.Algorithm/` — F# 算法类库

### 已实现的模块
1. **共享数据模型** (`Recognition/Models/PuzzleModels.cs`)：`PuzzleData`、`TileInfo`、`ComponentInfo`、`SolveStep`、`SolveResult` 等
2. **图像识别** (`Recognition/PuzzleDetector.cs` + `ColorGrouper.cs`)：从 Python 原型移植，支持截图识别和 JSON 加载
3. **F# 算法骨架** (`Algorithm/Solver.fs`)：提供 `canPlace`、`placeComponent`、`StepRecorder` 等辅助函数，核心 `solve` 方法留 TODO 供用户实现
4. **WinUI 3 UI** (`MainWindow.xaml` + `MainWindow.xaml.cs`)：CommandBar 工具栏、Canvas 棋盘可视化、侧边栏信息面板、InfoBar 状态栏
5. **ViewModel** (`ViewModels/MainViewModel.cs`)：MVVM 架构，支持截图导入、JSON 导入、求解、步骤导航
6. **值转换器** (`Converters/InverseBoolToVisibilityConverter.cs`)：AOT 兼容的 `BoolToVisibilityConverter` 和 `InverseBoolToVisibilityConverter`

### 构建配置
- 目标框架：`net9.0-windows10.0.22621.0`
- NativeAOT：`PublishAot=true`
- 平台：x86 / x64 / ARM64
- 非打包模式：`WindowsPackageType=None`
- SDK 版本固定：`global.json` 固定 .NET 9 SDK（避免 .NET 10 兼容性问题）

### 已知问题
- MVVMTK0045 警告：CommunityToolkit.Mvvm 8.4.0 的 `[ObservableProperty]` field 模式在 WinRT AOT 场景下有兼容性警告（不影响开发和调试，发布时可关注）

## 相关文件
- `EndfieldPuzzleSolver.sln` — 解决方案
- `global.json` — SDK 版本固定
- `src/EndfieldPuzzleSolver/EndfieldPuzzleSolver.csproj` — WinUI 3 主项目
- `src/EndfieldPuzzleSolver/MainWindow.xaml` / `.cs` — 主窗口
- `src/EndfieldPuzzleSolver/App.xaml` / `.cs` — 应用入口
- `src/EndfieldPuzzleSolver/ViewModels/MainViewModel.cs` — 主 ViewModel
- `src/EndfieldPuzzleSolver/Converters/InverseBoolToVisibilityConverter.cs` — 值转换器
- `src/EndfieldPuzzleSolver.Recognition/Models/PuzzleModels.cs` — 共享数据模型
- `src/EndfieldPuzzleSolver.Recognition/PuzzleDetector.cs` — 图像识别
- `src/EndfieldPuzzleSolver.Recognition/ColorGrouper.cs` — 颜色聚类
- `src/EndfieldPuzzleSolver.Algorithm/Solver.fs` — 算法实现（递归回溯 + 约束传播剪枝）
