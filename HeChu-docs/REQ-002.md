# REQ-002: 多分辨率与界面缩放支持

## 状态

- [ ] 待开发
- [ ] 开发中
- [x] 已完成

## 创建信息

- 创建时间: 2026-02-10
- 最后更新: 2026-02-10
- 优先级: 高

## 需求描述

使现有原型程序（`prototype/detect.py`）能够支持不同分辨率与界面缩放的游戏截图。

### 核心要求

1. **自动检测缩放系数**：程序从截图中**实测**出 UI 元素的实际尺寸，与模板原始尺寸对比得出缩放系数，而非用分辨率简单推算
2. **手动覆盖**：同时支持用户通过命令行参数手动指定缩放系数，覆盖自动检测结果
3. **元素自身等比例缩放**：游戏 UI 元素只会保持自身宽高比等比例缩放（不会拉伸变形），但缩放系数**不等于**分辨率比例——分辨率翻倍不代表 UI 元素尺寸翻倍，游戏有自己的 UI 缩放策略
4. **布局可变**：不同分辨率/缩放下，UI 元素的布局位置可能发生变化（如间距、偏移不同），但各元素的外观只是等比例缩放

### 输入变化

- 支持任意分辨率的截图，包括非标准比例（如超宽屏 21:9）
- 模板素材基于 1920×1080 截取，但 **不能假设** 其他分辨率下 UI 尺寸与 1080p 成固定比例

### 输出不变

- 输出的结构化 JSON 和可视化标注图格式不变
- 输出中的像素坐标反映实际截图中的位置（不做归一化）

## 边界条件

- 需支持任意分辨率，包括非 16:9 比例（如 21:9 超宽屏、4:3 等）
- 非 16:9 比例下，游戏可能在画面两侧/上下有黑边或留白，核心 UI 区域仍在中央
- **UI 缩放系数与分辨率不成固定比例**：不同分辨率下 UI 元素的实际像素大小取决于游戏自身的缩放策略，需从图像中实测
- 模板图片基于 1920×1080 截取，检测时需在多个缩放尺度下匹配模板以找到最佳匹配
- 极小分辨率（如 640×360）可能导致模板匹配精度下降，属于已知限制

## 技术路线

### 方案：多尺度模板匹配 + 实测缩放系数

1. **多尺度模板匹配探测缩放系数**
   - 在检测第一步（网格定位）时，对模板进行多尺度匹配：以一系列候选缩放因子（如 0.5~2.0，步长 0.05）缩放模板，逐一与截图做模板匹配
   - 取匹配得分最高的缩放因子作为实测 `scale`
   - 后续所有步骤复用该 `scale`

2. **手动覆盖**
   - 新增 `--scale` 命令行参数，用户可直接指定缩放系数，跳过多尺度探测
   - 未指定时执行自动探测

3. **模板缩放**
   - 确定 `scale` 后，将所有模板图像按 `scale` 等比例缩放
   - 缩放后的模板用于后续的 `matchTemplate` 匹配

4. **像素阈值参数化**
   - 将所有硬编码的像素阈值乘以 `scale`
   - 需要改造的已知硬编码位置（基于 REQ-001 代码审查）：

   | 位置 | 当前硬编码值 | 说明 |
   |------|-------------|------|
   | `_detect_grid` 过滤 | `65 < w < 100` | 格子匹配尺寸范围 |
   | `_infer_grid` 间距 | `> 30` | 最小有效间距 |
   | `_infer_grid` 默认值 | `87` | 默认格子尺寸 |
   | `_detect_requirements` | `margin = 150` | 需求搜索区域边距 |
   | `_find_bars` 面积 | `15 < area < 800` | 需求条面积范围 |
   | `_detect_components` 面积 | `area > 500, 30 < w < 200` | 元件 blob 过滤 |
   | `_parse_component_blob` 最小值 | `th < 10, tw < 10` | 最小裁剪尺寸 |
   | `_parse_component_blob` 格子范围 | `12 < cell < 45` | 元件网格单元尺寸范围 |

5. **比例相关逻辑保持不变**
   - 已经使用图像比例（如 `h // 6`、`3 * iw // 5`）的代码无需修改
   - 颜色阈值（HSV 空间）与分辨率无关，无需修改

6. **命令行接口扩展**
   - 新增 `--scale` 可选参数，接受浮点数
   - 未指定时执行多尺度自动探测

## 参考

- REQ-001 现有代码（`prototype/detect.py`）中的硬编码参数
- 模板素材基于 1920×1080 截取（`prototype/image/ui-template/`）
- 多尺度模板匹配技术（OpenCV `matchTemplate` + `cv2.resize`）

## 相关文件

- `prototype/detect.py` - 新增多尺度自动缩放探测、`--scale` 手动覆盖、并将多处像素阈值改为按缩放系数自适配

