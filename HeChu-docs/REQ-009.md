# REQ-009: 使用 component-flame 模板检测元件 UI

## 状态
- [ ] 待开发
- [ ] 开发中
- [x] 已完成

## 创建信息
- 创建时间: 2026-02-12
- 最后更新: 2026-02-12
- 优先级: 高

## 需求描述

将元件检测从纯 HSV  blob 检测改为基于 `component-flame.png` 模板匹配。每个元件卡片都有该边框（四角 L 形标记），通过模板匹配定位元件区域，从而排除非游戏 UI（如底部机器人、修门按钮）的误检。

### 当前问题

- `component-flame.png` 已被加载但从未使用
- 元件检测仅依赖 `sat>60 & val>60` 的连通域，底部高饱和高亮 UI 会被误识别为元件

### 期望效果

- 用 `component_flame` 模板在右侧区域进行 `matchTemplate` 匹配
- 仅在匹配成功的区域（元件卡片边框内）进行形状解析
- 谜题 2 不再误检元件 5（底部 UI）

## 边界条件

- 保持 puzzle0、puzzle1 的元件识别正确
- 模板需按当前 scale 缩放后匹配（与 tile_empty/tile_disable 一致）
- 若模板匹配无结果，可回退到原有 blob 检测作为兜底

## 技术路线

1. **模板匹配定位元件**
   - 在 ROI（`x >= 3/5 图像宽度`）内对 `component_flame` 做 `matchTemplate`，阈值约 0.7–0.8
   - 对匹配结果做 NMS 去重（与网格检测类似）
   - 匹配到的中心/边界即为元件卡片区域

2. **区域与形状解析**
   - 将模板匹配得到的矩形作为 `slot_pos`，替代原 blob 的 boundingRect
   - 在 slot 区域内继续用 `_parse_component_blob` 解析形状（HSV 提取内部绿色块）

3. **兜底逻辑**
   - 若匹配数 < 1，回退到原有 blob 检测流程，确保 puzzle0/puzzle1 兼容

## 参考

- REQ-008 元件误检原因分析
- `prototype/detect.py` 中 `_match_template`、`_nms`、`_detect_grid` 的模板匹配流程

## 相关文件

- `prototype/detect.py` - 新增 `_detect_components_by_template`、`_detect_components_by_blob`；元件检测优先模板匹配，兜底 blob 检测；增加 y 轴上限（grid_bottom + 150px）排除底部 UI
