# REQ-020: 修复组件颜色识别 Bug - 双色谜题只能识别一种颜色

## 状态
- [ ] 待开发
- [ ] 开发中
- [x] 已完成

## 创建信息
- 创建时间: 2026-02-14
- 最后更新: 2026-02-14
- 优先级: 高（关键 Bug）

## 需求描述

修复自 d810b4aa9460ee58462cdfe96d74b17c0fb902a2 提交后引入的 Bug：带有两种或多种元件颜色的谜题只能识别出第一种颜色，后续不同颜色的元件全部被错误归类到第一个颜色组。

### 问题现象

用户提供的截图显示谜题包含蓝色和绿色两种元件，但识别结果只显示蓝色：
- 预期：颜色组 A（蓝色）、颜色组 B（绿色）
- 实际：只识别出颜色组 A
- Python 原型工作正常，说明问题出在 C# 移植过程中

### 根本原因

在 [PuzzleDetector.cs](../src/EndfieldPuzzleSolver.Recognition/PuzzleDetector.cs#L943) 的 `ParseComponentBlob` 函数中，组件颜色处理逻辑错误：

**错误实现**（第 943 行）：
```csharp
var colorGroup = _colorGrouper.MatchNearest(avgH, avgS, avgV);
```

**正确实现**（对标 Python 原型）：
```csharp
var groupIdx = _colorGrouper.Register(avgH, avgS, avgV);
var colorGroup = ColorGrouper.Label(groupIdx);
```

#### 关键区别

- **`Register(h, s, v)`**：将颜色**注册**到 ColorGrouper
  - 如果色相相近（小于 `HueMergeDist`），合并到已有 cluster
  - 如果色相差异大，创建新的 cluster
  - 返回 cluster 索引

- **`MatchNearest(h, s, v)`**：只**匹配**最近的已有 cluster
  - 找到色相距离最近的 cluster，返回其 label
  - **不会创建新 cluster**
  - 当 cluster 为空时回退到 `Register`（这就是为什么第一个组件能被识别）

#### Python 原型代码

```python
# prototype/detect.py, line 1058
group_idx = self.color_grouper.register(avg_h, avg_s, avg_v)
return {
    'color_group': self.color_grouper.label(group_idx),
    ...
}
```

#### C# 移植错误

在 REQ-014（d810b4aa）中移植算法时，组件检测错误使用了 `MatchNearest`，导致：
1. 第一个组件（蓝色）：`MatchNearest` 发现 cluster 为空，回退到 `Register`，创建 cluster A
2. 第二个组件（绿色）：`MatchNearest` 只在已有 cluster 中匹配，绿色被强制归为 A（即使色相差异很大）

而锁定格使用 `MatchNearest` 是**正确的**，因为锁定格应该匹配已知的组件颜色，不应该创建新的颜色组。

## 实施方案

### 受影响文件

- [PuzzleDetector.cs](../src/EndfieldPuzzleSolver.Recognition/PuzzleDetector.cs#L943)（EndfieldPuzzleSolver.Recognition 项目）

### 代码变更

将组件检测中的颜色处理逻辑修改为与 Python 原型一致：

```diff
  var avgH = (int)(sumH / pxCount);
  var avgS = (int)(sumS / pxCount);
  var avgV = (int)(sumV / pxCount);
  if (avgV < _config.ComponentDetection.MinAvgValue)
      return null;

- var colorGroup = _colorGrouper.MatchNearest(avgH, avgS, avgV);
+ var groupIdx = _colorGrouper.Register(avgH, avgS, avgV);
+ var colorGroup = ColorGrouper.Label(groupIdx);
```

### 影响范围

- **WinUI3 应用**：`EndfieldPuzzleSolver` 项目使用 Recognition 库
- **Avalonia 应用**：`EndfieldPuzzleSolver.Avalonia` 项目通过 Core 项目间接使用 Recognition 库
- 修复后两个应用同时生效

## 验证方法

1. 编译 Recognition 项目，确保 0 错误 0 警告
2. 运行应用识别用户提供的双色谜题截图
3. 验证识别结果显示两个颜色组（A 和 B）
4. 验证每个颜色组的元件数量、HSV 值正确

## 相关需求

- REQ-014: WinUI3 图像识别算法与原型对齐（引入 Bug 的提交）
- REQ-010: 使用颜色标签（A/B/C）替代绿火蓝（ColorGrouper 设计原理）
