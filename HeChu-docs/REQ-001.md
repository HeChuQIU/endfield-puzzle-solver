# REQ-001: 终末地源石电路模块解谜 - UI 识别原型

## 状态
- [ ] 待开发
- [ ] 开发中
- [x] 已完成

## 创建信息
- 创建时间: 2026-02-10
- 最后更新: 2026-02-10
- 优先级: 高

## 需求描述

开发一个原型程序，验证通过截图自动识别《明日方舟：终末地》源石电路模块解谜小游戏 UI 元素的可行性。

### 输入
- 游戏界面截图（PNG 格式）

### 输出
1. **结构化 JSON 数据**，包含：
   - 游戏区域的网格尺寸（行数 × 列数）
   - 每个格子的类型（空格、禁用格、锁定/已着色格）
   - 行列需求计数（顶部和左侧的数量指示条，按颜色分组）
   - 右侧可用元件的形状（相对格子坐标）和颜色
2. **可视化标注图片**，在原图上框出识别到的各区域和元素

### 核心要求
- **颜色无关性**：UI 模板素材（`prototype/image/ui-template/`）来自特定颜色的截图，但不同关卡的元件颜色不同（如青色、蓝色、黄绿色等），需预处理模板使其适用于任意元件颜色
- **不预存元件类型**：不预先定义所有可能的元件形状，而是从截图中实时推断
- **可缓存**：识别结果支持缓存，避免重复计算

## 边界条件

- 原型阶段先固定分辨率（以样例截图 1920×1080 为准），后续再支持多分辨率
- 地图格子数不定（样例中有 5×5 和 4×4 的网格）
- 元件种类和数量任意（样例中有 L 形、T 形等）
- 可能同时存在多种颜色的元件（如 puzzle1.png 中蓝色 + 黄绿色），不同颜色的行列计数独立
- 灰色禁用格和已着色锁定格不可移动，锁定格参与计数
- 保证有解

## 技术路线

1. **图像预处理**
   - 将 ui-template 中的模板图转换为颜色无关的特征表示（如边缘检测、灰度梯度、结构特征）
   - 对输入截图做同样的预处理

2. **区域定位**（基于 OpenCV 模板匹配）
   - 使用 `puzzle-area-corner-lt.png` 定位游戏网格区域的左上角
   - 通过网格结构推断完整区域边界和网格尺寸

3. **格子类型识别**
   - 在已定位的网格内，逐格匹配 `tile-empty.png`、`tile-disable.png`、`tile-lock.png`
   - 锁定格需额外提取颜色信息

4. **行列需求识别**
   - 在网格区域的上方和左侧定位 `requirement-empty.png` / `requirement-full.png`
   - 按位置分组统计每行每列各颜色的需求数量

5. **元件识别**
   - 定位右侧元件面板区域
   - 识别每个元件的格子组成（形状）
   - 提取元件颜色
   - 对于多色元件，分别标注各颜色格子

6. **结果输出**
   - 生成结构化 JSON
   - 在原图上绘制标注框和标签，输出可视化图片

## 参考

- OpenCV 模板匹配方案（`cv2.matchTemplate`）
- 已有 UI 模板素材：`prototype/image/ui-template/` 目录下的 7 张模板图
- 样例截图：`prototype/image/sample/puzzle0.png`（青色，含禁用格和锁定格，5×5 网格）、`puzzle1.png`（蓝色+黄绿色，纯空网格，4×4 网格）

## UI 元素清单

| 模板文件 | 说明 | 用途 |
|---------|------|------|
| `puzzle-area-corner-lt.png` | 游戏区域左上角标记 | 定位网格区域 |
| `tile-empty.png` | 空格（四角有淡色十字标记） | 识别可放置区域 |
| `tile-disable.png` | 禁用格（⊘ 符号） | 识别不可用区域 |
| `tile-lock.png` | 锁定格（🔒 符号，带颜色边框） | 识别预置元件 |
| `requirement-empty.png` | 未满足的需求指示条 | 识别行列需求 |
| `requirement-full.png` | 已满足的需求指示条 | 识别行列需求 |
| `component-flame.png` | 元件区域的空背景框 | 定位右侧元件面板 |

## 相关文件
- `prototype/detect.py` - 主检测脚本，实现了网格检测、格子分类、行列需求和元件检测
- `prototype/requirements.txt` - Python 依赖列表（opencv-python, numpy）
- `prototype/image/output/puzzle0_result.json` - puzzle0 的检测结果 JSON
- `prototype/image/output/puzzle0_annotated.png` - puzzle0 的可视化标注图
- `prototype/image/output/puzzle1_result.json` - puzzle1 的检测结果 JSON
- `prototype/image/output/puzzle1_annotated.png` - puzzle1 的可视化标注图

## 验证结果

### puzzle0.png（5×5 网格，青色，含 disabled 和 lock 格子）
- **网格检测**：✅ 成功定位 5×5 网格，原点 (730, 310)，单元格尺寸 91×91px
- **格子分类**：✅ 完全正确，识别出 17 个 empty、6 个 disabled、2 个 lock
- **行列需求**：✅ 检测到 5 列 11 条需求、5 行 11 条需求（含 2 个 filled + 20 个 unfilled），颜色分组准确
- **元件检测**：✅ 检测到 3 个元件（L 形和 T 形），形状和颜色识别准确

### puzzle1.png（4×4 网格，蓝色+黄绿色双色，纯 empty）
- **网格检测**：✅ 成功定位 4×4 网格，原点 (775, 355)，单元格尺寸 92×92px
- **格子分类**：✅ 完全正确，所有 16 个格子均识别为 empty
- **行列需求**：✅ 检测到 4 列 14 条需求、4 行 14 条需求（全部 unfilled），双色分组准确
- **元件检测**：✅ 检测到 4 个元件（L 形），形状和双色识别准确

## 关键技术点总结

1. **颜色无关的模板匹配**：通过灰度转换和中心区域提取，成功适配不同颜色的关卡
2. **网格自动推断**：从模板匹配位置推断网格尺寸和单元格大小，无需预设参数
3. **HSV 饱和度检测**：有效区分 lock 格子和 empty/disabled 格子，并提取颜色信息
4. **轮廓检测**：用于行列需求条和元件识别，适配任意数量和颜色的需求
5. **自适应阈值检测**：
   - **Otsu 自动阈值**：替代固定 sat/val 阈值进行前景分离，自动适应不同背景亮度
   - **变异系数（CV）判断**：使用亮度变异系数（标准差/均值）判断需求条的填充状态
     - 实心条（filled）：内部亮度均匀，CV < 0.35
     - 空心条（unfilled）：边框亮+中心暗，CV > 0.4
   - **完全自适应**：无任何固定像素阈值，适用于任意背景亮度和模糊程度

## 调试功能

使用 `--debug` 选项可输出中间处理图像到 `output/puzzle_name_debug/` 目录：

**网格检测调试图**：
- `1_grid_matches.png` - 模板匹配结果（绿框标注）
- `1_grid_inferred.png` - 推断的网格线

**需求条检测调试图**：
- `3_col_bars.png` / `3_row_bars.png` - 标注后的 ROI（绿框=filled，红框=unfilled，标注 CV 值）
- `3_col_otsu_mask.png` / `3_row_otsu_mask.png` - Otsu 自适应分离的前景 mask

**元件检测调试图**：
- `4_comp_mask.png` - 元件区域的饱和度 mask
- `4_comp_blobs.png` - 检测到的元件轮廓
- `4_comp_N_mask.png` - 每个元件的独立 mask

示例：
```bash
python prototype/detect.py --debug prototype/image/sample/puzzle0.png
```
