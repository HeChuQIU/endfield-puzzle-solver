# REQ-011: 需求条按元件颜色相似度二值化检测

## 状态
- [ ] 待开发
- [ ] 开发中
- [x] 已完成

## 创建信息
- 创建时间: 2026-02-12
- 最后更新: 2026-02-12
- 优先级: 高

## 需求描述

将需求条检测从「Otsu 饱和度二值化」改为「按元件颜色相似度二值化」。每种元件颜色单独计算相似度图、二值化并检测，得到该颜色对应的需求条。

### 当前问题

- Otsu 在饱和度通道二值化，会检出任意高饱和区域（含非元件颜色的 UI）
- 空需求条被误判为已满足、部分需求条未被识别

### 期望效果

- 对每种元件颜色 i：计算像素与 (ch, cs, cv) 的相似度 → 越接近 1，越接近元件色
- 相似度图二值化得到 mask_i，在 mask_i 上 findContours
- 每种颜色得到各自的需求条，输出按 color_group 正确分组

## 边界条件

- 无元件颜色时，可回退到原有 Otsu 逻辑或返回空
- 保持 puzzle0、puzzle1、puzzle2 识别正确；puzzle2 需求条全空时应输出空

## 技术路线

1. **相似度计算**：`sim = max(0, 1 - hue_distance(h, ch) / 25)`，可结合 sat、val 过滤过暗像素
2. **按颜色循环**：对每个 `color_grouper.clusters[i]`，生成 `similarity_map` → 二值化 → `findContours`
3. **filled 判断**：沿用 val_cv 或基于 mask 内前景区域
4. **debug 输出**：可保存各颜色的 similarity_map 或 mask 供调试

## 参考

- `prototype/detect.py` 中 `_find_bars`、`hue_distance`

## 相关文件

- `prototype/detect.py` - 新增 `_similarity_map_for_color`；`_find_bars` 改为按每种元件颜色分别计算相似度图并二值化检测；debug 输出 3_*_sim_mask.png
