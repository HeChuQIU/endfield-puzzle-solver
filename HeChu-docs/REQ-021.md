# REQ-021: Avalonia UI 功能完善 - 对齐 WinUI3 版本界面功能

## 状态
- [ ] 待开发
- [ ] 开发中
- [x] 已完成

## 创建信息
- 创建时间: 2026-02-14
- 最后更新: 2026-02-14
- 优先级: 中

## 需求描述

完善 Avalonia 版本的 UI 功能，使其与 WinUI3 版本的界面功能完全一致。目前 Avalonia 版本存在以下功能缺失和显示问题：

### 问题清单

1. **颜色组显示不正确**
   - 当前：灰色方块 + 只显示标签（"A", "B"）
   - 期望：实际颜色方块 + 标签和 HSV 值（"A (H102 S188 V196)"）

2. **元件列表信息不完整**
   - 当前：只显示 "元件: A"
   - 期望：显示 "元件 1: A (3 格)" + 元件形状可视化（小方格矩阵）

3. **图标不符合语义**
   - 当前："打开截图" 按钮使用下载图标（下箭头）
   - 期望：使用文件夹/打开文件图标

4. **状态栏样式简陋**
   - 当前：简单文本
   - 期望：模拟 WinUI3 InfoBar 样式（带信息图标）

### WinUI3 参考实现

参考 [MainWindow.xaml.cs](../src/EndfieldPuzzleSolver/MainWindow.xaml.cs#L100-L170) 中的 `UpdatePuzzleInfo` 方法：

```csharp
// 颜色组：动态创建带实际颜色的 UI
foreach (var cg in p.ColorGroups)
{
    var brush = HsvToBrush(cg.Hue, cg.Saturation, cg.Value);
    var panel = new StackPanel { Orientation = Orientation.Horizontal, Spacing = 8 };
    panel.Children.Add(new Border { Width = 16, Height = 16, Background = brush, ... });
    panel.Children.Add(new TextBlock { Text = $"{cg.Label} (H{cg.Hue} S{cg.Saturation} V{cg.Value})", ... });
    ColorGroupsItems.Items.Add(panel);
}

// 元件列表：编号 + 形状可视化
for (int i = 0; i < p.Components.Length; i++)
{
    var comp = p.Components[i];
    var label = new TextBlock { Text = $"元件 {i + 1}: {comp.ColorGroup} ({comp.TileCount} 格)", ... };
    var shapeCanvas = new Canvas { ... };
    // 绘制形状小方格...
}
```

## 实施方案

### 变更文件

1. [MainWindow.axaml](../src/EndfieldPuzzleSolver.Avalonia/Views/MainWindow.axaml)
   - 移除 ColorGroupsItems 和 ComponentsItems 的 ItemTemplate 数据绑定
   - 改为在 code-behind 中动态构建
   - 更换按钮图标
   - 美化状态栏（添加信息图标）

2. [MainWindow.axaml.cs](../src/EndfieldPuzzleSolver.Avalonia/Views/MainWindow.axaml.cs)
   - 重构 `UpdatePuzzleInfo` 方法，参照 WinUI3 实现
   - 添加颜色组动态生成逻辑（HSV 转换、Border 创建）
   - 添加元件列表动态生成逻辑（编号、格数、形状 Canvas）

### 关键变更点

#### 1. AXAML 图标修复

**打开截图按钮**（从下载图标改为文件夹图标）：
```xml
<!-- 原来 -->
<PathIcon Data="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" Width="16" Height="16" />

<!-- 修改为 -->
<PathIcon Data="M19 20H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h4l2 3h8a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2z" Width="16" Height="16" />
```

#### 2. AXAML 移除数据绑定

```xml
<!-- 移除 ItemTemplate，改为代码生成 -->
<ItemsControl x:Name="ColorGroupsItems" />
<ItemsControl x:Name="ComponentsItems" />
```

#### 3. Code-behind 动态生成

```csharp
private void UpdatePuzzleInfo()
{
    // 清空并重建 Items
    ColorGroupsItems.Items.Clear();
    ComponentsItems.Items.Clear();
    
    // 颜色组：实际颜色 + HSV 值
    foreach (var cg in p.ColorGroups)
    {
        var brush = HsvToBrush(cg.Hue, cg.Saturation, cg.Value);
        var panel = new StackPanel { Orientation = Orientation.Horizontal, Spacing = 8 };
        panel.Children.Add(new Border { Width = 16, Height = 16, Background = brush, ... });
        panel.Children.Add(new TextBlock { Text = $"{cg.Label} (H{cg.Hue} S{cg.Saturation} V{cg.Value})", ... });
        ColorGroupsItems.Items.Add(panel);
    }
    
    // 元件列表：编号 + 形状矩阵
    for (int i = 0; i < p.Components.Length; i++)
    {
        var comp = p.Components[i];
        var brush = GetColorGroupBrush(p, comp.ColorGroup);
        
        var label = new TextBlock { Text = $"元件 {i + 1}: {comp.ColorGroup} ({comp.TileCount} 格)", Foreground = brush, ... };
        
        var shapeCanvas = new Canvas { Width = comp.Cols * ShapeCellSize, Height = comp.Rows * ShapeCellSize, ... };
        for (int sr = 0; sr < comp.Rows; sr++)
            for (int sc = 0; sc < comp.Cols; sc++)
                if (comp.Shape[sr, sc])
                    shapeCanvas.Children.Add(new Rectangle { ... });
        
        var container = new StackPanel();
        container.Children.Add(label);
        container.Children.Add(shapeCanvas);
        ComponentsItems.Items.Add(container);
    }
}
```

#### 4. 状态栏美化

添加信息图标圆圈（模拟 InfoBar 样式）：
```xml
<Border Grid.Row="2" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}" Padding="12,8">
  <StackPanel Orientation="Horizontal" Spacing="8">
    <Border x:Name="StatusIcon" Width="20" Height="20" CornerRadius="10" Background="#0078D4">
      <TextBlock Text="ⓘ" Foreground="White" FontSize="12" HorizontalAlignment="Center" VerticalAlignment="Center" />
    </Border>
    <TextBlock x:Name="StatusTextBlock" Text="{Binding StatusMessage}" VerticalAlignment="Center" />
  </StackPanel>
</Border>
```

## 验证方法

1. 编译 Avalonia 项目，确保 0 错误 0 警告
2. 运行应用识别谜题截图
3. 验证颜色组显示实际颜色和 HSV 值
4. 验证元件列表显示编号、格数和形状矩阵
5. 验证按钮图标和状态栏样式符合预期

## 相关需求

- REQ-019: 新增 Avalonia 跨平台 UI 版本（基础框架）
- REQ-018: 使用 ContentIsland 布局分离谜题组件（WinUI3 布局参考）
