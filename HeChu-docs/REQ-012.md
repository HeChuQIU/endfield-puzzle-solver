# REQ-012: 配置文件系统 - 图像识别参数提取

## 状态
- [ ] 待开发
- [ ] 开发中
- [x] 已完成

## 创建信息
- 创建时间: 2026-02-12
- 最后更新: 2026-02-12
- 优先级: 高

## 需求描述

将 `prototype/detect.py` 中所有硬编码的图像识别参数提取到一个 TOML 配置文件中，实现集中管理和灵活调节。要求配置文件结构清晰、分组合理，每个参数都有详细的注释说明其作用和推荐范围。

## 边界条件
无特殊情况

## 技术路线

### 1. 配置文件结构设计

采用分层分组的 TOML 结构，按功能模块组织参数：

```toml
# 颜色分组参数
[color_grouping]
hue_merge_distance = 18  # Hue 差值小于此阈值视为同种颜色（0-180 范围）

# 自动缩放探测参数
[auto_scaling]
search_range = [0.5, 2.0]   # 缩放系数搜索范围 [min, max]
step_size = 0.05           # 搜索步长
roi_horizontal_ratio = [1/6, 2/3]  # ROI 水平范围比例 [start, end]
roi_vertical_ratio = [1/6, 5/6]   # ROI 垂直范围比例 [start, end]

# 网格检测参数
[grid_detection]
# 模板匹配
template_match_threshold = 0.80  # 模板匹配阈值（0.0-1.0）
used_templates = ["tile-empty", "tile-disable"]  # 使用的模板列表

# 非极大值抑制（NMS）
nms_iou_threshold = 0.5  # NMS IOU 阈值（0.0-1.0）

# 格子尺寸过滤
min_cell_size = 65  # 格子最小尺寸（像素）
max_cell_size = 100 # 格子最大尺寸（像素）

# 网格推断
min_gap_size = 30   # 格子间距最小值（像素）
default_cell_size = 87  # 默认格子尺寸（像素）

# 格子分类参数
[tile_classification]
# 内部区域缩进比例
inner_margin_ratio = 0.1  # 内部区域缩进比例（0.0-0.5）

# 锁定格检测
lock_min_saturation = 80   # 锁定格最小饱和度（0-255）
lock_min_value = 80        # 锁定格最小亮度（0-255）
lock_min_pixel_ratio = 0.10  # 锁定格最小像素占比（0.0-1.0）
lock_min_avg_value = 100   # 锁定格最小平均亮度（0-255）
lock_min_avg_saturation = 100  # 锁定格最小平均饱和度（0-255）

# 模板匹配分类
tile_min_score = 0.35  # 模板匹配最小得分（0.0-1.0）

# 兜底分类
empty_mean_value_threshold = 45    # 空格平均亮度阈值（0-255）
empty_variance_threshold = 200    # 空格灰度方差阈值
disabled_mean_value_threshold = 60  # 禁用格平均亮度阈值（0-255）
disabled_variance_threshold = 100  # 禁用格灰度方差阈值

# 需求条检测参数
[requirement_detection]
# 搜索范围
search_margin = 150  # 搜索边距（像素）

# 颜色相似度计算
hue_similarity_width = 10   # Hue 相似度宽度（0-180）
min_saturation = 50         # 最小饱和度（0-255）
min_value = 55             # 最小亮度（0-255）

# 形状过滤
min_area = 15    # 最小面积（缩放后的平方像素）
max_area = 800  # 最大面积（缩放后的平方像素）
max_aspect_ratio = 6.0  # 最大长宽比

# 填充判断
filled_cv_threshold = 0.35  # 填充状态变异系数阈值（0.0-1.0）
min_region_size = 5        # 最小区域尺寸（像素）

# 元件检测参数
[component_detection]
# 搜索范围
search_start_x_ratio = 0.6  # 右侧区域起始位置比例（0.0-1.0）
y_limit_offset = 150       # Y轴上限偏移（像素）

# 模板匹配检测
template_scales = [0.5, 0.6, 0.7, 0.8, 1.0]  # 多尺度列表
template_match_min_score = 0.55  # 最小匹配得分（0.0-1.0）
template_match_max_score = 0.75  # 最大匹配得分（0.0-1.0）
template_nms_iou_threshold = 0.5  # NMS IOU 阈值（0.0-1.0）
min_template_size = 45  # 模板最小尺寸（像素）
max_template_size = 130  # 模板最大尺寸（像素）

# Blob 检测（回退方案）
blob_min_saturation = 60  # Blob 最小饱和度（0-255）
blob_min_value = 60       # Blob 最小亮度（0-255）
blob_min_area = 500       # Blob 最小面积（缩放后的平方像素）
blob_min_size = 30        # Blob 最小尺寸（像素）
blob_max_size = 200       # Blob 最大尺寸（像素）
blob_max_aspect_ratio = 4.0  # Blob 最大长宽比

# 形状推断
min_shape_size = 10       # 形状最小尺寸（像素）
max_shape_size = 45       # 形状最大尺寸（像素）
min_total_cells = 2       # 最小总格子数
max_total_cells = 12      # 最大总格子数
min_rows = 1              # 最小行数
max_rows = 4              # 最大行数
min_cols = 1              # 最小列数
max_cols = 4              # 最大列数
cell_fill_threshold = 0.40  # 格子填充阈值（0.0-1.0）
clear_filled_threshold = 0.60  # 清晰填充阈值（0.0-1.0）
clear_empty_threshold = 0.15   # 清晰空阈值（0.0-1.0）
min_color_pixels = 30  # 最小颜色像素数（缩放后的平方像素）
min_avg_value = 80     # 最小平均亮度（0-255）
```

### 2. 配置加载实现

使用 Python 的 `toml` 库实现配置加载：

```python
import toml
from pathlib import Path
from typing import Dict, Any

class Config:
    def __init__(self, config_path: Path):
        with open(config_path, 'r', encoding='utf-8') as f:
            self._raw = toml.load(f)
    
    def get(self, key_path: str, default=None) -> Any:
        """支持点号分隔的路径访问，如 'color_grouping.hue_merge_distance'"""
        keys = key_path.split('.')
        value = self._raw
        for k in keys:
            if isinstance(value, dict):
                value = value.get(k)
                if value is None:
                    return default
            else:
                return default
        return value
```

### 3. 代码重构

将硬编码参数替换为从配置读取：

- `PuzzleDetector.__init__` 接收 Config 对象
- 所有硬编码常量改为 `self.config.get(...)`
- 保留构造函数参数以覆盖配置值（如 `--scale` 参数优先级最高）

### 4. 默认配置文件

在 `prototype/image/config.toml` 创建默认配置文件，包含上述所有参数的合理默认值。

## 参考

- Python TOML 库: https://pypi.org/project/toml/
- TOML 规范: https://toml.io/

## 相关文件
- `prototype/config.py` - 新建配置加载模块，提供 Config 类和 load_default_config 函数
- `prototype/image/config.toml` - 新建默认配置文件，包含所有图像识别参数
- `prototype/detect.py` - 重构为使用配置系统，所有硬编码参数改为从配置读取
- `prototype/requirements.txt` - 新增 toml>=0.10.2 依赖
- `Pillow>=10.0.0` 依赖
