# REQ-010: 取色逻辑改为仅在识别出的元件上取色

## 状态
- [ ] 待开发
- [ ] 开发中
- [x] 已完成

## 创建信息
- 创建时间: 2026-02-12
- 最后更新: 2026-02-12
- 优先级: 中

## 需求描述

### 当前取色逻辑

`ColorGrouper.register()` 在三个位置被调用，颜色来源混杂：

| 来源 | 位置 | 说明 |
|------|------|------|
| **锁格** | `_classify_cell` | 锁格内高饱和高亮像素 → register |
| **需求条** | `_find_bars` | Otsu 分割出的需求条轮廓内像素 → register |
| **元件** | `_parse_component_blob` | 元件 blob 内 sat>60 & val>60 像素 → register |

这导致：需求条误检（如「00」「000」数字）会引入 B、C 等错误颜色；锁格若与元件色不同也会增加颜色组。

### 期望效果

- **仅从识别出的元件上取色**：`color_groups` 只反映元件颜色
- 锁格、需求条的颜色组：通过匹配到最近的元件颜色来分配，不再调用 `register`

## 边界条件

- 若无元件（极端情况），`match_nearest` 需有合理兜底（如返回 `?` 或临时注册）
- 保持 puzzle0、puzzle1、puzzle2 的识别结果正确

## 技术路线

1. **调整检测顺序**：`grid` → `components` → `tiles` → `requirements`，使元件颜色先入库
2. **ColorGrouper 新增 `match_nearest(h,s,v)`**：在已有 cluster 中找 Hue 距离最近者，返回其 label；无 cluster 时可临时 register 或返回 `?`
3. **锁格**：`_classify_cell` 中锁格改为调用 `match_nearest`，不再 `register`
4. **需求条**：`_find_bars` 中改为调用 `match_nearest`，不再 `register`
5. **元件**：`_parse_component_blob` 保持 `register` 不变

## 参考

- `prototype/detect.py` 中 `ColorGrouper`、`hue_distance`

## 相关文件

- `prototype/detect.py` - ColorGrouper 新增 match_nearest；检测顺序改为 grid→components→tiles→requirements；锁格与需求条改用 match_nearest 匹配元件颜色
