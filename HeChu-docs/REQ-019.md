# REQ-019: 新增 Avalonia 跨平台 UI 版本

## 状态
- [ ] 待开发
- [ ] 开发中
- [x] 已完成

## 创建信息
- 创建时间: 2026-02-14
- 最后更新: 2026-02-14
- 优先级: 高

## 需求描述

新增一个 Avalonia 版本的应用程序，要求：

1. **功能完全一致**：与现有 WinUI 3 版本功能完全相同
   - 打开截图识别谜题
   - 自动求解并显示结果
   - 拖拽图片加载
   - 显示谜题信息、颜色组、元件列表
   - Canvas 绘制棋盘

2. **代码共享架构**：
   - 共享 Recognition 图像识别库
   - 共享 Algorithm 求解算法库（F#）
   - 共享 ViewModel 层（需提取到独立 Core 项目）
   - 仅 View 层独立实现

3. **UI 外观**：保持与 WinUI 3 类似的外观风格
   - 使用 Avalonia Fluent 主题
   - 卡片式布局
   - 相同的配色和圆角边框

4. **技术栈**：
   - 使用 CommunityToolkit.Mvvm 源生成器
   - 遵循 .NET 社区工具包最佳实践
   - 仅支持 Windows 平台

## 边界条件

1. **平台限制**：仅需要支持 Windows 平台（不需要 macOS/Linux）
2. **代码兼容**：现有 WinUI 3 项目应继续正常工作，不受影响
3. **依赖注入**：Avalonia 使用内置 DI 容器
4. **配置文件**：共享 appsettings.json 配置

## 技术路线

### 项目结构调整

```
src/
├── EndfieldPuzzleSolver.Core/           # 新增：共享核心层
│   ├── ViewModels/
│   │   └── MainViewModel.cs
│   ├── Converters/
│   └── EndfieldPuzzleSolver.Core.csproj
│
├── EndfieldPuzzleSolver/                # 现有：WinUI 3 项目
│   ├── MainWindow.xaml / .cs           # View 层（保留）
│   └── 引用 Core 项目
│
├── EndfieldPuzzleSolver.Avalonia/       # 新增：Avalonia 项目
│   ├── Views/
│   │   └── MainWindow.axaml / .axaml.cs
│   ├── Assets/UiTemplates/             # 模板图片
│   ├── App.axaml / .axaml.cs
│   └── EndfieldPuzzleSolver.Avalonia.csproj
│
├── EndfieldPuzzleSolver.Recognition/    # 现有：图像识别
└── EndfieldPuzzleSolver.Algorithm/      # 现有：求解算法（F#）
```

### 关键步骤

1. **创建 Core 项目**
   - 提取 MainViewModel 到独立项目
   - 提取共享 Converter
   - 配置项目引用 Recognition 和 Algorithm

2. **创建 Avalonia 项目**
   - 使用 Avalonia 模板创建
   - 添加 CommunityToolkit.Mvvm 包
   - 配置 Fluent 主题
   - 实现 MainWindow.axaml 视图

3. **重构 WinUI 3 项目**
   - 移除 ViewModel 代码，改为引用 Core
   - 保持其他代码不变

4. **实现 Avalonia View 层**
   - 翻译 MainWindow.xaml → MainWindow.axaml
   - 实现 Canvas 绘制逻辑
   - 实现文件选择器（Windows 特有 API）
   - 实现拖拽支持

5. **配置 Native AOT 发布**
   - 启用 PublishAot 和 PublishSingleFile
   - 优化输出大小（StripSymbols, InvariantGlobalization）

### NuGet 依赖

**EndfieldPuzzleSolver.Core:**
- CommunityToolkit.Mvvm (8.4.0)
- Microsoft.Extensions.Configuration
- Microsoft.Extensions.Configuration.Json
- Microsoft.Extensions.Configuration.Binder

**EndfieldPuzzleSolver.Avalonia:**
- Avalonia (11.2.5)
- Avalonia.Desktop (11.2.5)
- Avalonia.Themes.Fluent (11.2.5)
- CommunityToolkit.Mvvm (8.4.0)

## 参考

- [Avalonia 官方文档](https://docs.avaloniaui.net/)
- [CommunityToolkit.Mvvm 文档](https://learn.microsoft.com/dotnet/communitytoolkit/mvvm/)
- 现有 WinUI 3 实现：`src/EndfieldPuzzleSolver/`

## 相关文件
- `src/EndfieldPuzzleSolver.Core/EndfieldPuzzleSolver.Core.csproj` - 新增：共享核心层项目
- `src/EndfieldPuzzleSolver.Core/ViewModels/MainViewModel.cs` - 从 WinUI 3 提取的 ViewModel
- `src/EndfieldPuzzleSolver.Avalonia/EndfieldPuzzleSolver.Avalonia.csproj` - 新增：Avalonia 项目（含 AOT 配置）
- `src/EndfieldPuzzleSolver.Avalonia/App.axaml(.cs)` - Avalonia 应用入口
- `src/EndfieldPuzzleSolver.Avalonia/Program.cs` - 程序入口
- `src/EndfieldPuzzleSolver.Avalonia/Views/MainWindow.axaml(.cs)` - Avalonia 主窗口
- `src/EndfieldPuzzleSolver.Avalonia/appsettings.json` - Avalonia 配置文件
- `src/EndfieldPuzzleSolver.Avalonia/Assets/UiTemplates/` - 模板图片文件
- `src/EndfieldPuzzleSolver/EndfieldPuzzleSolver.csproj` - 修改：引用 Core 项目
- `src/EndfieldPuzzleSolver/MainWindow.xaml.cs` - 修改：使用 Core.ViewModel
