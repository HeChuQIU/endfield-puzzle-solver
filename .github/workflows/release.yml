name: Release Avalonia Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: è¿˜åŸä¾èµ–
      run: dotnet restore
      
    - name: å‘å¸ƒ Avalonia é¡¹ç›®
      run: |
        dotnet publish src/EndfieldPuzzleSolver.Avalonia/EndfieldPuzzleSolver.Avalonia.csproj `
          -c Release `
          -r win-x64 `
          --self-contained `
          -o publish/avalonia `
          -p:PublishAot=true `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true
      
    - name: ç§»é™¤ä¸å¿…è¦çš„æ–‡ä»¶
      run: |
        Remove-Item publish/avalonia/*.pdb -Force -ErrorAction SilentlyContinue
        Remove-Item publish/avalonia/*.xml -Force -ErrorAction SilentlyContinue
        Remove-Item publish/avalonia/opencv_videoio_ffmpeg4110_64.dll -Force -ErrorAction SilentlyContinue
        
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        $version = "${{ github.event.inputs.version }}"
        $zipName = "EndfieldPuzzleSolver-Avalonia-$version-win-x64.zip"
        Compress-Archive -Path publish/avalonia/* -DestinationPath $zipName
        echo "RELEASE_ZIP=$zipName" >> $env:GITHUB_ENV
        
    - name: è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
      run: |
        $hash = (Get-FileHash $env:RELEASE_ZIP -Algorithm SHA256).Hash
        echo "SHA256: $hash" | Out-File -FilePath release-notes.txt
        echo "FILE_HASH=$hash" >> $env:GITHUB_ENV
        
    - name: åˆ›å»º Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: ${{ github.event.inputs.version }}
        body: |
          ## Endfield Puzzle Solver - Avalonia ç‰ˆæœ¬
          
          **ç‰ˆæœ¬**: ${{ github.event.inputs.version }}
          **å¹³å°**: Windows x64
          **æ„å»ºæ—¶é—´**: ${{ github.run_id }}
          
          ### ğŸ“¦ åŒ…å«å†…å®¹
          - EndfieldPuzzleSolver.Avalonia.exe (ä¸»ç¨‹åº)
          - å¿…éœ€çš„è¿è¡Œæ—¶ DLL
          - Assets èµ„æºæ–‡ä»¶
          - appsettings.json é…ç½®æ–‡ä»¶
          
          ### ğŸ“ ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½ zip æ–‡ä»¶
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `EndfieldPuzzleSolver.Avalonia.exe`
          
          ### ğŸ” æ–‡ä»¶æ ¡éªŒ
          SHA256: ${{ env.FILE_HASH }}
          
          ### âš ï¸ ç³»ç»Ÿè¦æ±‚
          - Windows 10/11 x64
          - æ— éœ€å®‰è£… .NET è¿è¡Œæ—¶
        files: |
          ${{ env.RELEASE_ZIP }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
